    <!-- ... (head and body start remain the same) ... -->

    <script>
        // ... (variable declarations remain the same) ...

        let pyodide = null;
        let textProcessorFunc = null;
        let nltkSetupDone = false; // Flag to track NLTK setup

        // Initialize Pyodide, load NLTK, and Python script
        async function loadPyodideAndPackages() {
            statusDiv.textContent = 'Loading Python runtime (Pyodide)...';
            try {
                pyodide = await loadPyodide();
                statusDiv.textContent = 'Python runtime loaded. Loading packages (nltk)...';

                // Load micropip to install packages
                await pyodide.loadPackage(['micropip']);
                const micropip = pyodide.pyimport("micropip");

                // Install nltk
                await micropip.install('nltk');
                statusDiv.textContent = 'NLTK installed. Loading text processor script...';

                 // Fetch the Python script content
                const response = await fetch('text_processor.py');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const pythonScript = await response.text();

                // Run the Python script to define functions
                pyodide.runPython(pythonScript);

                // Get a reference to the Python function AFTER script runs
                textProcessorFunc = pyodide.globals.get('process_text');

                // --- Trigger NLTK data download ---
                // Get the downloader function from Python script's global scope
                const downloadNltkFunc = pyodide.globals.get('download_nltk_data');
                statusDiv.textContent = 'Setting up NLTK data (WordNet, etc.)... Please wait.';
                // Run the download function (this might take a moment)
                await downloadNltkFunc(); // Use await if it were async, but nltk.download is sync
                nltkSetupDone = true; // Mark setup as complete
                // -----------------------------------

                statusDiv.textContent = 'Ready. Select a PDF file and click "Process PDF".';
                processBtn.disabled = false; // Enable button

            } catch (error) {
                console.error('Error loading Pyodide or Python script/packages:', error);
                statusDiv.textContent = `Error loading components: ${error}. Please refresh the page.`;
                statusDiv.classList.add('error');
                processBtn.disabled = true;
            }
        }

        // ... (extractTextFromPdf function remains the same) ...

        // Event listener for the button
        processBtn.addEventListener('click', async () => {
            const file = fileInput.files[0];
            const numWords = parseInt(numWordsInput.value, 10);

            if (!file) { /* ... */ return; }
            if (!pyodide || !textProcessorFunc) { /* ... */ return; }
            // Check if NLTK setup is complete
            if (!nltkSetupDone) {
                 statusDiv.textContent = 'NLTK setup not complete. Please wait or refresh.';
                 return;
            }
            if (isNaN(numWords) || numWords < 1) { /* ... */ return; }

            statusDiv.textContent = 'Processing... Reading PDF file.';
            // ... (rest of the button click logic remains largely the same) ...

            try {
                // 1. Extract text
                statusDiv.textContent = 'Processing... Extracting text from PDF.';
                const extractedText = await extractTextFromPdf(file);
                if (!extractedText) { /* ... */ return; }

                // 2. Process text using Python
                statusDiv.textContent = 'Processing... Analyzing text (Tokenizing, Lemmatizing...).';
                const results = await Promise.resolve(textProcessorFunc(extractedText, numWords));
                const jsResults = results.toJs({ deep: true });

                // 3. Display results
                statusDiv.textContent = `Processing complete. Found ${jsResults.length} frequent words.`;
                 if (jsResults.length > 0) {
                    if (jsResults[0][0] === "Error" || jsResults[0][0] === "Error processing text") {
                        wordListOl.innerHTML = `<li class="error">Python Error: ${jsResults[0][1]}</li>`;
                    } else {
                        wordListOl.innerHTML = ''; // Clear previous results before adding new ones
                        jsResults.forEach(([word, count]) => {
                            const li = document.createElement('li');
                            li.textContent = `${word}: ${count}`;
                            wordListOl.appendChild(li);
                        });
                    }
                    resultsDiv.style.display = 'block';
                } else {
                    statusDiv.textContent = 'Processing complete. No significant words found after filtering.';
                    resultsDiv.style.display = 'none'; // Hide results area if empty
                }

            } catch (error) {
                 // ... (error handling remains the same) ...
            } finally {
                processBtn.disabled = false; // Re-enable button
            }
        });

        // Initialize when the page loads
        processBtn.disabled = true; // Disable button initially
        loadPyodideAndPackages(); // Call the updated loading function

    </script>

</body>
</html>
